# 使用Ubuntu 20.04作为基础镜像
FROM ubuntu:20.04

# 安装必要的依赖
RUN apt-get update && apt-get install -y \
    build-essential zlib1g-dev libssl-dev libpam0g-dev libselinux1-dev autoconf \
    git

# 设置环境变量，避免在安装软件包过程中出现交互式提示
ENV DEBIAN_FRONTEND=noninteractive

# 创建特权分离的用户 sshd
RUN groupadd sshd && \
    useradd -r -g sshd -d /var/empty -s /sbin/nologin sshd && \
    mkdir /var/empty && \
    chmod 711 /var/empty && \
    chown root:sshd /var/empty

# 创建 SSH 用户目录
RUN mkdir /var/run/sshd

# 添加新用户并设置密码
RUN useradd -m fatmo && echo "fatmo:666666" | chpasswd
# RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# 清理apt缓存和临时文件
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# 设置工作目录
WORKDIR /usr/src/openssh-exploit

# 挂载本地的OpenSSH源码目录
VOLUME ["/usr/src/openssh-portable"]

# 暴露SSH端口
EXPOSE 22

# 容器启动时的命令
CMD ["sh", "-c", "autoreconf -fvi && ./configure --prefix=/usr/local --sysconfdir=/usr/local/etc --with-pam --with-md5-passwords && make && make install && /usr/local/sbin/sshd -D -e -f /usr/local/etc/sshd_config"]

# 重置环境变量
ENV DEBIAN_FRONTEND=dialog